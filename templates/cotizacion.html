{% extends "base.html" %}
{% block content %}
<div class="main-container">
  <h2 class="titulo-seccion">Generador de Cotizaciones</h2>
  <p class="subtitulo">Crear y gestionar cotizaciones</p>

  <div class="cotizacion-grid">
    <!-- Formulario -->
    <div class="cotizacion-card">
      <h3>Generar nueva cotizaci√≥n</h3>
      <form action="/generar_cotizacion" method="post" id="form-cotizacion">
        
        <!-- CLIENTE -->
        <div class="form-group">
          <label>Selecciona el cliente</label>
          <select name="id_cliente" id="cliente-select" required>
            <option value="">Seleccione...</option>
            {% for cliente in clientes %}
            <option value="{{ cliente[0] }}">{{ cliente[1] }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- PRODUCTOS - M√öLTIPLES PRODUCTOS -->
        <div class="seccion-productos">
          <h4>Productos a cotizar</h4>
          <div id="lista-productos">
            <!-- Producto 1 -->
            <div class="producto-item" data-index="1">
              <div class="producto-header">
                <span class="producto-numero">Producto 1</span>
                <button type="button" class="btn-eliminar-producto" onclick="eliminarProducto(1)">
                  üóëÔ∏è
                </button>
              </div>
              
              <div class="form-grid">
                <div class="form-group">
                  <label>Selecciona producto</label>
                  <select name="productos[1][id_combinacion]" class="producto-select" required>
                    <option value="">Seleccione...</option>
                    {% for p in productos %}
                    <option value="{{ p['id_combinacion'] }}" 
                            data-costo="{{ p['precio'] }}"
                            data-nombre="{{ p['nombre'] }}">
                      {{ p['nombre'] }} ({{ p['modelo'] }}) - ${{ p['precio'] }} c/u
                    </option>
                    {% endfor %}
                  </select>
                </div>

                <div class="form-group">
                  <label>Cantidad</label>
                  <div class="cantidad-control">
                    <button type="button" class="btn-cantidad" onclick="cambiarCantidad(1, -1)">-</button>
                    <input type="number" name="productos[1][cantidad]" class="cantidad-input" 
                           value="1" min="1" readonly>
                    <button type="button" class="btn-cantidad" onclick="cambiarCantidad(1, 1)">+</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bot√≥n para agregar m√°s productos -->
          <button type="button" class="btn-agregar-producto" onclick="agregarProducto()">
            ‚ûï Agregar otro producto
          </button>
        </div>

        <!-- RESUMEN EN TIEMPO REAL -->
        <div id="resumen-cotizacion" class="resumen-cotizacion" style="display: none;">
          <h4>Resumen de cotizaci√≥n:</h4>
          <div id="detalles-productos"></div>
          <div class="resumen-total">
            <span>Total estimado:</span>
            <span>$<span id="total-cotizacion">0</span></span>
          </div>
        </div>

        <button type="submit" class="btn-rosa" id="btn-generar">Generar cotizaci√≥n</button>
      </form>
    </div>

    <!-- Historial -->
    <div class="cotizacion-card">
      <div class="header-historial">
        <h3>Historial de cotizaciones</h3>
        <button class="btn-exportar-todo" onclick="exportarTodo()">
          üìä Exportar Todo
        </button>
      </div>
      
      <div class="tabla-container">
        <table class="tabla-bonita">
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Productos</th>
              <th>Total</th>
              <th>Estado</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for cot in cotizaciones %}
            <tr>
              <td>#{{ cot['id_cotizacion'] }}</td>
              <td>{{ cot['nombre_cliente'] }}</td>
              <td>
                <div class="productos-resumen">
                  {{ cot['cantidad_productos'] }} productos
                  <small>({{ cot['cantidad_total'] }} unidades)</small>
                </div>
              </td>
              <td>${{ "%.2f"|format(cot['total_estimado']) }}</td>
              <td>
                <span class="estado estado-{{ cot['estado'] }}">
                  {{ cot['estado'] }}
                </span>
              </td>
              <td>{{ cot['fecha_emision'][:10] }}</td>
              <td>
                <div class="acciones-cotizacion">
                  <button class="btn-accion btn-ver" 
                          onclick="verDetalleCotizacion({{ cot['id_cotizacion'] }})" 
                          title="Ver detalle">
                    üëÅÔ∏è
                  </button>
                  <button class="btn-accion btn-eliminar" 
                          onclick="confirmarEliminarCotizacion({{ cot['id_cotizacion'] }})" 
                          title="Eliminar">
                    üóëÔ∏è
                  </button>
                  <button class="btn-accion btn-exportar" 
                          onclick="exportarCotizacion({{ cot['id_cotizacion'] }})" 
                          title="Exportar PDF">
                    üìÑ
                  </button>
                  <button class="btn-accion btn-copiar" 
                          onclick="confirmarDuplicar({{ cot['id_cotizacion'] }})" 
                          title="Duplicar">
                    üìã
                  </button>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="sin-registros">No hay cotizaciones registradas</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal para ver detalle -->
<div id="modal-detalle" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="cerrarModal()">&times;</span>
    <h3>Detalle de Cotizaci√≥n</h3>
    <div id="contenido-detalle"></div>
  </div>
</div>

<style>
.main-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.cotizacion-grid {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 2rem;
}

.cotizacion-card {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-group select, .form-group input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.seccion-productos {
    margin: 1.5rem 0;
}

.producto-item {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
}

.producto-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.producto-numero {
    font-weight: 600;
    color: #495057;
}

.btn-eliminar-producto {
    background: #dc3545;
    color: white;
    border: none;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    cursor: pointer;
}

.form-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1rem;
}

.cantidad-control {
    display: flex;
    gap: 0.25rem;
}

.btn-cantidad {
    flex: 1;
    padding: 0.5rem;
    background: #f0f0f0;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
}

.cantidad-input {
    text-align: center;
    font-weight: bold;
}

.btn-agregar-producto {
    width: 100%;
    padding: 0.75rem;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}

.resumen-cotizacion {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    margin: 1rem 0;
}

.resumen-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #dee2e6;
}

.resumen-total {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    font-size: 1.2rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 2px solid #dee2e6;
    color: #28a745;
}

.header-historial {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.btn-exportar-todo {
    padding: 0.5rem 1rem;
    background: #17a2b8;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.tabla-bonita {
    width: 100%;
    border-collapse: collapse;
}

.tabla-bonita th {
    background: #f8f9fa;
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.tabla-bonita td {
    padding: 0.75rem;
    border-bottom: 1px solid #dee2e6;
}

.productos-resumen small {
    display: block;
    color: #6c757d;
    font-size: 0.85rem;
}

.estado {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
}

.estado-pendiente {
    background: #ffc107;
    color: #856404;
}

.estado-aprobada {
    background: #28a745;
    color: white;
}

.estado-rechazada {
    background: #dc3545;
    color: white;
}

.estado-completada {
    background: #6c757d;
    color: white;
}

.acciones-cotizacion {
    display: flex;
    gap: 0.25rem;
}

.btn-accion {
    padding: 0.25rem 0.5rem;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 1.2rem;
}

.btn-rosa {
    width: 100%;
    padding: 0.75rem;
    background: #FF69B4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}

.btn-rosa:hover {
    background: #FF1493;
}

.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
}

.modal-content {
    background: white;
    margin: 5% auto;
    padding: 2rem;
    border-radius: 8px;
    max-width: 600px;
    position: relative;
}

.close {
    position: absolute;
    right: 1rem;
    top: 1rem;
    font-size: 2rem;
    cursor: pointer;
}
</style>

<script>
let contadorProductos = 1;
let productosDisponibles = {{ productos|tojson }};

function agregarProducto() {
    contadorProductos++;
    const opciones = productosDisponibles.map(p => 
        `<option value="${p.id_combinacion}" data-costo="${p.precio}" data-nombre="${p.nombre}">
            ${p.nombre} (${p.modelo}) - $${p.precio} c/u
        </option>`
    ).join('');
    
    const nuevoProducto = `
        <div class="producto-item" data-index="${contadorProductos}">
            <div class="producto-header">
                <span class="producto-numero">Producto ${contadorProductos}</span>
                <button type="button" class="btn-eliminar-producto" onclick="eliminarProducto(${contadorProductos})">
                    üóëÔ∏è
                </button>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Selecciona producto</label>
                    <select name="productos[${contadorProductos}][id_combinacion]" class="producto-select" required>
                        <option value="">Seleccione...</option>
                        ${opciones}
                    </select>
                </div>

                <div class="form-group">
                    <label>Cantidad</label>
                    <div class="cantidad-control">
                        <button type="button" class="btn-cantidad" onclick="cambiarCantidad(${contadorProductos}, -1)">-</button>
                        <input type="number" name="productos[${contadorProductos}][cantidad]" 
                               class="cantidad-input" value="1" min="1" readonly>
                        <button type="button" class="btn-cantidad" onclick="cambiarCantidad(${contadorProductos}, 1)">+</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('lista-productos').insertAdjacentHTML('beforeend', nuevoProducto);
    actualizarResumen();
}

function eliminarProducto(index) {
    const producto = document.querySelector(`.producto-item[data-index="${index}"]`);
    if (document.querySelectorAll('.producto-item').length > 1) {
        producto.remove();
        renumerarProductos();
        actualizarResumen();
    } else {
        alert('Debe haber al menos un producto en la cotizaci√≥n');
    }
}

function renumerarProductos() {
    const productos = document.querySelectorAll('.producto-item');
    productos.forEach((producto, index) => {
        const nuevoIndex = index + 1;
        producto.setAttribute('data-index', nuevoIndex);
        producto.querySelector('.producto-numero').textContent = `Producto ${nuevoIndex}`;
        
        const select = producto.querySelector('.producto-select');
        const cantidad = producto.querySelector('.cantidad-input');
        
        select.name = `productos[${nuevoIndex}][id_combinacion]`;
        cantidad.name = `productos[${nuevoIndex}][cantidad]`;
        
        producto.querySelector('.btn-eliminar-producto').onclick = () => eliminarProducto(nuevoIndex);
        producto.querySelectorAll('.btn-cantidad').forEach(btn => {
            if (btn.textContent === '-') {
                btn.onclick = () => cambiarCantidad(nuevoIndex, -1);
            } else {
                btn.onclick = () => cambiarCantidad(nuevoIndex, 1);
            }
        });
    });
    contadorProductos = productos.length;
}

function cambiarCantidad(index, cambio) {
    const input = document.querySelector(`.producto-item[data-index="${index}"] .cantidad-input`);
    let nuevaCantidad = parseInt(input.value) + cambio;
    
    if (nuevaCantidad >= 1) {
        input.value = nuevaCantidad;
        actualizarResumen();
    }
}

function actualizarResumen() {
    const productos = document.querySelectorAll('.producto-item');
    let total = 0;
    let detallesHTML = '';
    
    productos.forEach(producto => {
        const select = producto.querySelector('.producto-select');
        const cantidad = producto.querySelector('.cantidad-input').value;
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption.value) {
            const precio = parseFloat(selectedOption.getAttribute('data-costo'));
            const nombre = selectedOption.getAttribute('data-nombre');
            const subtotal = precio * parseInt(cantidad);
            total += subtotal;
            
            detallesHTML += `
                <div class="resumen-item">
                    <span>${nombre}</span>
                    <span>${cantidad} x $${precio} = $${subtotal.toFixed(2)}</span>
                </div>
            `;
        }
    });
    
    if (detallesHTML) {
        document.getElementById('resumen-cotizacion').style.display = 'block';
        document.getElementById('detalles-productos').innerHTML = detallesHTML;
        document.getElementById('total-cotizacion').textContent = total.toFixed(2);
    } else {
        document.getElementById('resumen-cotizacion').style.display = 'none';
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('producto-select')) {
            actualizarResumen();
        }
    });
});

async function verDetalleCotizacion(id) {
    try {
        const response = await fetch(`/api/cotizacion/${id}`);
        const cotizacion = await response.json();
        
        let html = `
            <p><strong>Cliente:</strong> ${cotizacion.nombre_cliente}</p>
            <p><strong>Fecha:</strong> ${cotizacion.fecha_emision}</p>
            <p><strong>Estado:</strong> <span class="estado estado-${cotizacion.estado}">${cotizacion.estado}</span></p>
            <h4>Productos:</h4>
            <ul>
        `;
        
        cotizacion.productos.forEach(p => {
            html += `<li>${p.cantidad} unidades - Subtotal: $${p.subtotal}</li>`;
        });
        
        html += `</ul><p class="total"><strong>Total: $${cotizacion.total_estimado}</strong></p>`;
        
        document.getElementById('contenido-detalle').innerHTML = html;
        document.getElementById('modal-detalle').style.display = 'block';
    } catch (error) {
        alert('Error al cargar detalle de cotizaci√≥n');
    }
}

function cerrarModal() {
    document.getElementById('modal-detalle').style.display = 'none';
}

function confirmarEliminarCotizacion(id) {
    if (confirm('¬øEst√°s seguro de eliminar esta cotizaci√≥n?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/eliminar_cotizacion/${id}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function confirmarDuplicar(id) {
    if (confirm('¬øDeseas duplicar esta cotizaci√≥n?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/duplicar_cotizacion/${id}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function exportarCotizacion(id) {
    alert(`Exportando cotizaci√≥n #${id} a PDF - Funcionalidad en desarrollo`);
}

function exportarTodo() {
    alert('Exportando todo el historial - Funcionalidad en desarrollo');
}
</script>

{% endblock %}